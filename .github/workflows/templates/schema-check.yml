name: Schema Check

on:
  pull_request:
    paths:
      - parquedb.config.ts

concurrency:
  group: schema-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  schema:
    name: Check Schema Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: parquedb/setup-action@v1

      - name: Run schema diff
        id: schema-diff
        run: |
          parquedb schema diff > schema_diff.txt
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          cat schema_diff.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          PARQUEDB_TOKEN: ${{ secrets.PARQUEDB_TOKEN }}

      - name: Check for breaking changes
        id: breaking
        run: |
          if parquedb schema diff --check-breaking; then
            echo "has_breaking=false" >> $GITHUB_OUTPUT
          else
            echo "has_breaking=true" >> $GITHUB_OUTPUT
          fi
        env:
          PARQUEDB_TOKEN: ${{ secrets.PARQUEDB_TOKEN }}

      - name: Post schema changes comment
        uses: actions/github-script@v7
        with:
          script: |
            const diff = `${{ steps.schema-diff.outputs.diff }}`;
            const hasBreaking = '${{ steps.breaking.outputs.has_breaking }}' === 'true';

            let body = '## Schema Changes\n\n';
            if (hasBreaking) {
              body += '> **Warning**: This PR contains breaking schema changes!\n\n';
            }
            body += '```diff\n' + diff + '\n```';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
