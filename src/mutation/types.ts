/**
 * Type definitions for the mutation layer
 *
 * This module provides types for the mutation execution system including
 * context, results, and validation options.
 */

import type {
  Entity,
  EntityId,
  CreateInput,
  UpdateInput,
  Filter,
  CreateOptions,
  UpdateOptions,
  DeleteOptions,
  ValidationMode,
  Event,
} from '../types'

// =============================================================================
// Mutation Context
// =============================================================================

/**
 * Context for mutation operations
 * Contains all information needed to execute a mutation
 */
export interface MutationContext {
  /** Namespace for the operation */
  namespace: string

  /** Actor performing the operation */
  actor: EntityId

  /** Current timestamp */
  timestamp: Date

  /** Whether this is part of a transaction */
  inTransaction: boolean

  /** Transaction ID (if in transaction) */
  transactionId?: string

  /** Validation mode */
  validationMode: ValidationMode | false

  /** Whether to skip validation entirely */
  skipValidation: boolean
}

/**
 * Create a mutation context with defaults
 */
export function createMutationContext(
  namespace: string,
  options?: Partial<MutationContext>
): MutationContext {
  return {
    namespace,
    actor: options?.actor || ('system/anonymous' as EntityId),
    timestamp: options?.timestamp || new Date(),
    inTransaction: options?.inTransaction || false,
    transactionId: options?.transactionId,
    validationMode: options?.validationMode ?? 'strict',
    skipValidation: options?.skipValidation || false,
  }
}

// =============================================================================
// Mutation Results
// =============================================================================

/**
 * Result of a create operation
 */
export interface CreateResult<T = Record<string, unknown>> {
  /** The created entity */
  entity: Entity<T>

  /** The generated entity ID */
  entityId: EntityId

  /** Events generated by the operation */
  events: MutationEvent[]
}

/**
 * Result of an update operation
 */
export interface UpdateResult<T = Record<string, unknown>> {
  /** The entity state (before or after based on options) */
  entity: Entity<T> | null

  /** Whether the entity was modified */
  modified: boolean

  /** Whether this was an upsert (insert) */
  upserted: boolean

  /** Events generated by the operation */
  events: MutationEvent[]
}

/**
 * Result of a delete operation
 */
export interface DeleteResult {
  /** Number of entities deleted */
  deletedCount: number

  /** IDs of deleted entities */
  deletedIds: EntityId[]

  /** Events generated by the operation */
  events: MutationEvent[]
}

/**
 * Result of a bulk mutation operation
 */
export interface BulkMutationResult {
  /** Whether all operations succeeded */
  ok: boolean

  /** Number of successful operations */
  successCount: number

  /** Number of failed operations */
  failureCount: number

  /** Errors for failed operations */
  errors: MutationError[]

  /** Events generated by successful operations */
  events: MutationEvent[]
}

// =============================================================================
// Mutation Events
// =============================================================================

/**
 * Event generated by a mutation operation
 */
export interface MutationEvent {
  /** Event operation type */
  op: 'CREATE' | 'UPDATE' | 'DELETE'

  /** Target identifier */
  target: string

  /** State before the change */
  before: Record<string, unknown> | null

  /** State after the change */
  after: Record<string, unknown> | null

  /** Actor who made the change */
  actor: EntityId

  /** Timestamp of the change */
  timestamp: Date

  /** Whether this is a relationship event */
  isRelationship?: boolean

  /** Relationship predicate (if relationship event) */
  predicate?: string
}

// =============================================================================
// Mutation Errors
// =============================================================================

/**
 * Error that occurred during a mutation
 */
export interface MutationError {
  /** Index in bulk operation (if applicable) */
  index?: number

  /** The entity ID involved */
  entityId?: EntityId

  /** Error code */
  code: string

  /** Error message */
  message: string

  /** Original error */
  cause?: Error
}

/**
 * Error codes for mutation operations
 */
export const MutationErrorCodes = {
  VALIDATION_FAILED: 'VALIDATION_FAILED',
  NOT_FOUND: 'NOT_FOUND',
  VERSION_CONFLICT: 'VERSION_CONFLICT',
  CONSTRAINT_VIOLATION: 'CONSTRAINT_VIOLATION',
  RELATIONSHIP_ERROR: 'RELATIONSHIP_ERROR',
  ALREADY_EXISTS: 'ALREADY_EXISTS',
  DELETED: 'DELETED',
  INVALID_OPERATION: 'INVALID_OPERATION',
  TRANSACTION_ERROR: 'TRANSACTION_ERROR',
} as const

export type MutationErrorCode = typeof MutationErrorCodes[keyof typeof MutationErrorCodes]

/**
 * Custom error class for mutation operations
 */
export class MutationOperationError extends Error {
  readonly code: MutationErrorCode
  readonly entityId?: EntityId

  constructor(code: MutationErrorCode, message: string, entityId?: EntityId) {
    super(message)
    this.name = 'MutationOperationError'
    this.code = code
    this.entityId = entityId
  }
}

// =============================================================================
// Mutation Handlers
// =============================================================================

/**
 * Handler for pre-mutation hooks
 */
export type PreMutationHandler = (
  context: MutationContext,
  operation: 'create' | 'update' | 'delete',
  data: unknown
) => Promise<void> | void

/**
 * Handler for post-mutation hooks
 */
export type PostMutationHandler = (
  context: MutationContext,
  operation: 'create' | 'update' | 'delete',
  result: unknown,
  events: MutationEvent[]
) => Promise<void> | void

/**
 * Mutation hooks configuration
 */
export interface MutationHooks {
  /** Called before any mutation */
  preMutation?: PreMutationHandler[]

  /** Called after successful mutation */
  postMutation?: PostMutationHandler[]

  /** Called before create */
  preCreate?: PreMutationHandler[]

  /** Called after create */
  postCreate?: PostMutationHandler[]

  /** Called before update */
  preUpdate?: PreMutationHandler[]

  /** Called after update */
  postUpdate?: PostMutationHandler[]

  /** Called before delete */
  preDelete?: PreMutationHandler[]

  /** Called after delete */
  postDelete?: PostMutationHandler[]
}

// =============================================================================
// Operator Application
// =============================================================================

/**
 * Options for applying update operators
 */
export interface ApplyOperatorsOptions {
  /** Whether this is an insert (for $setOnInsert) */
  isInsert?: boolean

  /** Current timestamp to use */
  timestamp?: Date
}

/**
 * Result of applying update operators
 */
export interface ApplyOperatorsResult {
  /** The updated document */
  document: Record<string, unknown>

  /** Fields that were modified */
  modifiedFields: string[]

  /** Relationship operations ($link, $unlink) */
  relationshipOps: RelationshipOperation[]
}

/**
 * Relationship operation to be processed
 */
export interface RelationshipOperation {
  /** Operation type */
  type: 'link' | 'unlink'

  /** Predicate name */
  predicate: string

  /** Target entity IDs */
  targets: EntityId[]
}
