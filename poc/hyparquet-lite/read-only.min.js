var fe=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],R=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],be=["REQUIRED","OPTIONAL","REPEATED"],Te=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],xe=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],j=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"];var Re=["SPHERICAL","VINCENTY","THOMAS","ANDOYER","KARNEY"];function W(e){let t=z(e);if(t.type===1)return{type:"Point",coordinates:oe(e,t)};if(t.type===2)return{type:"LineString",coordinates:se(e,t)};if(t.type===3)return{type:"Polygon",coordinates:Le(e,t)};if(t.type===4){let n=[];for(let i=0;i<t.count;i++)n.push(oe(e,z(e)));return{type:"MultiPoint",coordinates:n}}else if(t.type===5){let n=[];for(let i=0;i<t.count;i++)n.push(se(e,z(e)));return{type:"MultiLineString",coordinates:n}}else if(t.type===6){let n=[];for(let i=0;i<t.count;i++)n.push(Le(e,z(e)));return{type:"MultiPolygon",coordinates:n}}else if(t.type===7){let n=[];for(let i=0;i<t.count;i++)n.push(W(e));return{type:"GeometryCollection",geometries:n}}else throw new Error(`Unsupported geometry type: ${t.type}`)}function z(e){let{view:t}=e,n=t.getUint8(e.offset++)===1,i=t.getUint32(e.offset,n);e.offset+=4;let r=i%1e3,f=Math.floor(i/1e3),s=0;r>1&&r<=7&&(s=t.getUint32(e.offset,n),e.offset+=4);let o=2;return f&&o++,f===3&&o++,{littleEndian:n,type:r,dim:o,count:s}}function oe(e,t){let n=[];for(let i=0;i<t.dim;i++){let r=e.view.getFloat64(e.offset,t.littleEndian);e.offset+=8,n.push(r)}return n}function se(e,t){let n=[];for(let i=0;i<t.count;i++)n.push(oe(e,t));return n}function Le(e,t){let{view:n}=e,i=[];for(let r=0;r<t.count;r++){let f=n.getUint32(e.offset,t.littleEndian);e.offset+=4,i.push(se(e,{...t,count:f}))}return i}var Ne=new TextDecoder,P={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)},stringFromBytes(e){return e&&Ne.decode(e)},geometryFromBytes(e){return e&&W({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})},geographyFromBytes(e){return e&&W({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})}};function le(e,t,n,i){if(t&&n.endsWith("_DICTIONARY")){let r=e;e instanceof Uint8Array&&!(t instanceof Uint8Array)&&(r=new t.constructor(e.length));for(let f=0;f<e.length;f++)r[f]=t[e[f]];return r}else return ce(e,i)}function ce(e,t){let{element:n,parsers:i,utf8:r=!0,schemaPath:f}=t,{type:s,converted_type:o,logical_type:a}=n;if(f?.some(c=>c.element.logical_type?.type==="VARIANT")&&s==="BYTE_ARRAY"&&o!=="UTF8"&&a?.type!=="STRING")return e;if(o==="DECIMAL"){let l=10**-(n.scale||0),d=new Array(e.length);for(let m=0;m<d.length;m++)e[m]instanceof Uint8Array?d[m]=ae(e[m])*l:d[m]=Number(e[m])*l;return d}if(!o&&s==="INT96")return Array.from(e).map(c=>i.timestampFromNanoseconds(nt(c)));if(o==="DATE")return Array.from(e).map(c=>i.dateFromDays(c));if(o==="TIMESTAMP_MILLIS")return Array.from(e).map(c=>i.timestampFromMilliseconds(c));if(o==="TIMESTAMP_MICROS")return Array.from(e).map(c=>i.timestampFromMicroseconds(c));if(o==="JSON")return e.map(c=>JSON.parse(Ne.decode(c)));if(o==="BSON")throw new Error("parquet bson not supported");if(o==="INTERVAL")throw new Error("parquet interval not supported");if(a?.type==="GEOMETRY")return e.map(c=>i.geometryFromBytes(c));if(a?.type==="GEOGRAPHY")return e.map(c=>i.geographyFromBytes(c));if(o==="UTF8"||a?.type==="STRING"||r&&s==="BYTE_ARRAY")return e.map(c=>i.stringFromBytes(c));if(o==="UINT_64"||a?.type==="INTEGER"&&a.bitWidth===64&&!a.isSigned){if(e instanceof BigInt64Array)return new BigUint64Array(e.buffer,e.byteOffset,e.length);let c=new BigUint64Array(e.length);for(let l=0;l<c.length;l++)c[l]=BigInt(e[l]);return c}if(o==="UINT_32"||a?.type==="INTEGER"&&a.bitWidth===32&&!a.isSigned){if(e instanceof Int32Array)return new Uint32Array(e.buffer,e.byteOffset,e.length);let c=new Uint32Array(e.length);for(let l=0;l<c.length;l++)c[l]=e[l];return c}if(a?.type==="FLOAT16")return Array.from(e).map(ue);if(a?.type==="TIMESTAMP"){let{unit:c}=a,l=i.timestampFromMilliseconds;c==="MICROS"&&(l=i.timestampFromMicroseconds),c==="NANOS"&&(l=i.timestampFromNanoseconds);let d=new Array(e.length);for(let m=0;m<d.length;m++)d[m]=l(e[m]);return d}return e}function ae(e){if(!e.length)return 0;let t=0n;for(let i of e)t=t*256n+BigInt(i);let n=e.length*8;return t>=2n**BigInt(n-1)&&(t-=2n**BigInt(n)),Number(t)}function nt(e){let t=(e>>64n)-2440588n,n=e&0xffffffffffffffffn;return t*86400000000000n+n}function ue(e){if(!e)return;let t=e[1]<<8|e[0],n=t>>15?-1:1,i=t>>10&31,r=t&1023;return i===0?n*2**-14*(r/1024):i===31?r?NaN:n*(1/0):n*2**(i-15)*(1+r/1024)}function Oe(e,t,n){let i=e[t],r=[],f=1;if(i.num_children)for(;r.length<i.num_children;){let s=e[t+f],o=Oe(e,t+f,[...n,s.name]);f+=o.count,r.push(o)}return{count:f,element:i,children:r,path:n}}function H(e,t){let n=Oe(e,0,[]),i=[n];for(let r of t){let f=n.children.find(s=>s.element.name===r);if(!f)throw new Error(`parquet schema element not found: ${t}`);i.push(f),n=f}return i}function Se(e){let t=[];function n(i){if(i.children.length)for(let r of i.children)n(r);else t.push(i.path.join("."))}return n(e),t}function _e(e){let t=0;for(let{element:n}of e)n.repetition_type==="REPEATED"&&t++;return t}function F(e){let t=0;for(let{element:n}of e.slice(1))n.repetition_type!=="REQUIRED"&&t++;return t}function Pe(e){if(!e||e.element.converted_type!=="LIST"||e.children.length>1)return!1;let t=e.children[0];return!(t.children.length>1||t.element.repetition_type!=="REPEATED")}function Be(e){if(!e||e.element.converted_type!=="MAP"||e.children.length>1)return!1;let t=e.children[0];return!(t.children.length!==2||t.element.repetition_type!=="REPEATED"||t.children.find(r=>r.element.name==="key")?.element.repetition_type==="REPEATED"||t.children.find(r=>r.element.name==="value")?.element.repetition_type==="REPEATED")}function de(e){if(e.length!==2)return!1;let[,t]=e;return!(t.element.repetition_type==="REPEATED"||t.children.length)}var v={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function D(e){let t=0,n={};for(;e.offset<e.view.byteLength;){let[i,r,f]=Ue(e,t);if(t=f,i===v.STOP)break;n[`field_${r}`]=Z(e,i)}return n}function Z(e,t){switch(t){case v.TRUE:return!0;case v.FALSE:return!1;case v.BYTE:return e.view.getInt8(e.offset++);case v.I16:case v.I32:return De(e);case v.I64:return K(e);case v.DOUBLE:{let n=e.view.getFloat64(e.offset,!0);return e.offset+=8,n}case v.BINARY:{let n=L(e),i=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n);return e.offset+=n,i}case v.LIST:{let n=e.view.getUint8(e.offset++),i=n&15,r=n>>4;r===15&&(r=L(e));let f=i===v.TRUE||i===v.FALSE,s=new Array(r);for(let o=0;o<r;o++)s[o]=f?Z(e,v.BYTE)===1:Z(e,i);return s}case v.STRUCT:{let n={},i=0;for(;;){let[r,f,s]=Ue(e,i);if(i=s,r===v.STOP)break;n[`field_${f}`]=Z(e,r)}return n}default:throw new Error(`thrift unhandled type: ${t}`)}}function L(e){let t=0,n=0;for(;;){let i=e.view.getUint8(e.offset++);if(t|=(i&127)<<n,!(i&128))return t;n+=7}}function it(e){let t=0n,n=0n;for(;;){let i=e.view.getUint8(e.offset++);if(t|=BigInt(i&127)<<n,!(i&128))return t;n+=7n}}function De(e){let t=L(e);return t>>>1^-(t&1)}function K(e){let t=it(e);return t>>1n^-(t&1n)}function Ue(e,t){let n=e.view.getUint8(e.offset++),i=n&15;if(i===v.STOP)return[0,0,t];let r=n>>4,f=r?t+r:De(e);return[i,f,f]}function Me(e,t){let n=new Map,i=t?.find(({key:f})=>f==="geo")?.value,r=(i&&JSON.parse(i)?.columns)??{};for(let[f,s]of Object.entries(r)){if(s.encoding!=="WKB")continue;let o=s.edges==="spherical"?"GEOGRAPHY":"GEOMETRY",a=s.crs?.id??s.crs?.ids?.[0],_=a?`${a.authority}:${a.code.toString()}`:void 0;n.set(f,{type:o,crs:_})}for(let f=1;f<e.length;f++){let s=e[f],{logical_type:o,name:a,num_children:_,repetition_type:c,type:l}=s;if(_){f+=_;continue}l==="BYTE_ARRAY"&&o===void 0&&c!=="REPEATED"&&(s.logical_type=n.get(a))}}var rt=1<<19,ft=new TextDecoder;function b(e){return e&&ft.decode(e)}async function Ce(e,{parsers:t,initialFetchSize:n=rt,geoparquet:i=!0}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");let r=Math.max(0,e.byteLength-n),f=await e.slice(r,e.byteLength),s=new DataView(f);if(s.getUint32(f.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let o=s.getUint32(f.byteLength-8,!0);if(o>e.byteLength-8)throw new Error(`parquet metadata length ${o} exceeds available buffer ${e.byteLength-8}`);if(o+8>n){let a=e.byteLength-o-8,_=await e.slice(a,r),c=new ArrayBuffer(o+8),l=new Uint8Array(c);return l.set(new Uint8Array(_)),l.set(new Uint8Array(f),r-a),$e(c,{parsers:t,geoparquet:i})}else return $e(f,{parsers:t,geoparquet:i})}function $e(e,{parsers:t,geoparquet:n=!0}={}){if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");let i=new DataView(e);if(t={...P,...t},i.byteLength<8)throw new Error("parquet file is too short");if(i.getUint32(i.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let r=i.byteLength-8,f=i.getUint32(r,!0);if(f>i.byteLength-8)throw new Error(`parquet metadata length ${f} exceeds available buffer ${i.byteLength-8}`);let s=r-f,a=D({view:i,offset:s}),_=a.field_1,c=a.field_2.map(p=>({type:fe[p.field_1],type_length:p.field_2,repetition_type:be[p.field_3],name:b(p.field_4),num_children:p.field_5,converted_type:Te[p.field_6],scale:p.field_7,precision:p.field_8,field_id:p.field_9,logical_type:ot(p.field_10)})),l=c.filter(p=>p.type),d=a.field_3,m=a.field_4.map(p=>({columns:p.field_1.map((u,y)=>({file_path:b(u.field_1),file_offset:u.field_2,meta_data:u.field_3&&{type:fe[u.field_3.field_1],encodings:u.field_3.field_2?.map(w=>R[w]),path_in_schema:u.field_3.field_3.map(b),codec:xe[u.field_3.field_4],num_values:u.field_3.field_5,total_uncompressed_size:u.field_3.field_6,total_compressed_size:u.field_3.field_7,key_value_metadata:u.field_3.field_8?.map(w=>({key:b(w.field_1),value:b(w.field_2)})),data_page_offset:u.field_3.field_9,index_page_offset:u.field_3.field_10,dictionary_page_offset:u.field_3.field_11,statistics:st(u.field_3.field_12,l[y],t),encoding_stats:u.field_3.field_13?.map(w=>({page_type:j[w.field_1],encoding:R[w.field_2],count:w.field_3})),bloom_filter_offset:u.field_3.field_14,bloom_filter_length:u.field_3.field_15,size_statistics:u.field_3.field_16&&{unencoded_byte_array_data_bytes:u.field_3.field_16.field_1,repetition_level_histogram:u.field_3.field_16.field_2,definition_level_histogram:u.field_3.field_16.field_3},geospatial_statistics:u.field_3.field_17&&{bbox:u.field_3.field_17.field_1&&{xmin:u.field_3.field_17.field_1.field_1,xmax:u.field_3.field_17.field_1.field_2,ymin:u.field_3.field_17.field_1.field_3,ymax:u.field_3.field_17.field_1.field_4,zmin:u.field_3.field_17.field_1.field_5,zmax:u.field_3.field_17.field_1.field_6,mmin:u.field_3.field_17.field_1.field_7,mmax:u.field_3.field_17.field_1.field_8},geospatial_types:u.field_3.field_17.field_2}},offset_index_offset:u.field_4,offset_index_length:u.field_5,column_index_offset:u.field_6,column_index_length:u.field_7,crypto_metadata:u.field_8,encrypted_column_metadata:u.field_9})),total_byte_size:p.field_2,num_rows:p.field_3,sorting_columns:p.field_4?.map(u=>({column_idx:u.field_1,descending:u.field_2,nulls_first:u.field_3})),file_offset:p.field_5,total_compressed_size:p.field_6,ordinal:p.field_7})),h=a.field_5?.map(p=>({key:b(p.field_1),value:b(p.field_2)})),g=b(a.field_6);return n&&Me(c,h),{version:_,schema:c,num_rows:d,row_groups:m,key_value_metadata:h,created_by:g,metadata_length:f}}function C({schema:e}){return H(e,[])[0]}function ot(e){return e?.field_1?{type:"STRING"}:e?.field_2?{type:"MAP"}:e?.field_3?{type:"LIST"}:e?.field_4?{type:"ENUM"}:e?.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e?.field_6?{type:"DATE"}:e?.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:Fe(e.field_7.field_2)}:e?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:Fe(e.field_8.field_2)}:e?.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e?.field_11?{type:"NULL"}:e?.field_12?{type:"JSON"}:e?.field_13?{type:"BSON"}:e?.field_14?{type:"UUID"}:e?.field_15?{type:"FLOAT16"}:e?.field_16?{type:"VARIANT",specification_version:e.field_16.field_1}:e?.field_17?{type:"GEOMETRY",crs:b(e.field_17.field_1)}:e?.field_18?{type:"GEOGRAPHY",crs:b(e.field_18.field_1),algorithm:Re[e.field_18.field_2]}:e}function Fe(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function st(e,t,n){return e&&{max:Q(e.field_1,t,n),min:Q(e.field_2,t,n),null_count:e.field_3,distinct_count:e.field_4,max_value:Q(e.field_5,t,n),min_value:Q(e.field_6,t,n),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function Q(e,t,n){let{type:i,converted_type:r,logical_type:f}=t;if(e===void 0)return e;if(i==="BOOLEAN")return e[0]===1;if(i==="BYTE_ARRAY")return n.stringFromBytes(e);let s=new DataView(e.buffer,e.byteOffset,e.byteLength);return i==="FLOAT"&&s.byteLength===4?s.getFloat32(0,!0):i==="DOUBLE"&&s.byteLength===8?s.getFloat64(0,!0):i==="INT32"&&r==="DATE"?n.dateFromDays(s.getInt32(0,!0)):i==="INT64"&&r==="TIMESTAMP_MILLIS"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):i==="INT64"&&r==="TIMESTAMP_MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):i==="INT64"&&f?.type==="TIMESTAMP"&&f?.unit==="NANOS"?n.timestampFromNanoseconds(s.getBigInt64(0,!0)):i==="INT64"&&f?.type==="TIMESTAMP"&&f?.unit==="MICROS"?n.timestampFromMicroseconds(s.getBigInt64(0,!0)):i==="INT64"&&f?.type==="TIMESTAMP"?n.timestampFromMilliseconds(s.getBigInt64(0,!0)):i==="INT32"&&s.byteLength===4?s.getInt32(0,!0):i==="INT64"&&s.byteLength===8?s.getBigInt64(0,!0):r==="DECIMAL"?ae(e)*10**-(t.scale||0):f?.type==="FLOAT16"?ue(e):e}function ke(e){let t=D(e);return{page_locations:t.field_1.map(lt),unencoded_byte_array_data_bytes:t.field_2}}function lt(e){return{offset:e.field_1,compressed_page_size:e.field_2,first_row_index:e.field_3}}function pe(e,t){for(let i=0;i<t.length;i+=1e4)e.push(...t.slice(i,i+1e4))}function T(e,t,n=!0){if(n?e===t:e==t)return!0;if(e instanceof Uint8Array&&t instanceof Uint8Array)return T(Array.from(e),Array.from(t),n);if(!e||!t||typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!T(e[r],t[r],n))return!1;return!0}if(typeof e!="object")return!1;let i=Object.keys(e);if(i.length!==Object.keys(t).length)return!1;for(let r of i)if(!T(e[r],t[r],n))return!1;return!0}function J(e){if(!e)return[];if(e.length===1)return e[0];let t=[];for(let n of e)pe(t,n);return t}function k(e){if(!e)return[];let t=[];return"$and"in e&&Array.isArray(e.$and)?t.push(...e.$and.flatMap(k)):"$or"in e&&Array.isArray(e.$or)?t.push(...e.$or.flatMap(k)):"$nor"in e&&Array.isArray(e.$nor)?t.push(...e.$nor.flatMap(k)):t.push(...Object.keys(e)),t}function U(e,t,n=!0){return"$and"in t&&Array.isArray(t.$and)?t.$and.every(i=>U(e,i,n)):"$or"in t&&Array.isArray(t.$or)?t.$or.some(i=>U(e,i,n)):"$nor"in t&&Array.isArray(t.$nor)?!t.$nor.some(i=>U(e,i,n)):Object.entries(t).every(([i,r])=>{let f=e[i];return typeof r!="object"||r===null||Array.isArray(r)?T(f,r,n):Object.entries(r||{}).every(([s,o])=>s==="$gt"?f>o:s==="$gte"?f>=o:s==="$lt"?f<o:s==="$lte"?f<=o:s==="$eq"?T(f,o,n):s==="$ne"?!T(f,o,n):s==="$in"?Array.isArray(o)&&o.includes(f):s==="$nin"?Array.isArray(o)&&!o.includes(f):s==="$not"?!U({[i]:f},{[i]:o},n):!0)})}function X({rowGroup:e,physicalColumns:t,filter:n,strict:i=!0}){if(!n)return!1;if("$and"in n&&Array.isArray(n.$and))return n.$and.some(r=>X({rowGroup:e,physicalColumns:t,filter:r,strict:i}));if("$or"in n&&Array.isArray(n.$or))return n.$or.every(r=>X({rowGroup:e,physicalColumns:t,filter:r,strict:i}));if("$nor"in n&&Array.isArray(n.$nor))return!1;for(let[r,f]of Object.entries(n)){let s=t.indexOf(r);if(s===-1)continue;let o=e.columns[s].meta_data?.statistics;if(!o)continue;let{min:a,max:_,min_value:c,max_value:l}=o,d=c!==void 0?c:a,m=l!==void 0?l:_;if(!(d===void 0||m===void 0)){for(let[h,g]of Object.entries(f||{}))if(h==="$gt"&&m<=g||h==="$gte"&&m<g||h==="$lt"&&d>=g||h==="$lte"&&d>g||h==="$eq"&&(g<d||g>m)||h==="$ne"&&T(d,m,i)&&T(d,g,i)||h==="$in"&&Array.isArray(g)&&g.every(p=>p<d||p>m)||h==="$nin"&&Array.isArray(g)&&T(d,m,i)&&g.includes(d))return!0}}return!1}var ct=1<<21;function qe({metadata:e,rowStart:t=0,rowEnd:n=1/0,columns:i,filter:r,filterStrict:f=!0,useOffsetIndex:s=!1}){if(!e)throw new Error("parquetPlan requires metadata");let o=[],a=[],_=[],c=Se(C(e)),l=0;for(let d of e.row_groups){let m=Number(d.num_rows),h=l+m;if(m>0&&h>t&&l<n&&!X({rowGroup:d,physicalColumns:c,filter:r,strict:f})){let g=[],p=1/0,u=-1/0;for(let A of d.columns){let I=A.meta_data;if(A.file_path)throw new Error("parquet file_path not supported");if(!I)throw new Error("parquet column metadata is undefined");if(!i||i.includes(I.path_in_schema[0])){let O=I.dictionary_page_offset||I.data_page_offset,x=Number(O),S=Number(O+I.total_compressed_size);if(x<p&&(p=x),S>u&&(u=S),s&&A.offset_index_offset&&A.offset_index_length){let V=Number(A.offset_index_offset);g.push({columnMetadata:I,offsetIndex:{startByte:V,endByte:V+A.offset_index_length},bounds:{startByte:x,endByte:S}})}else g.push({columnMetadata:I,range:{startByte:x,endByte:S}})}}let y=Math.max(t-l,0),w=Math.min(n-l,m);o.push({chunks:g,rowGroup:d,groupStart:l,groupRows:m,selectStart:y,selectEnd:w});let E;for(let A of g)if("offsetIndex"in A)_.push(A.offsetIndex);else{let{range:I}=A;i?a.push(I):E&&I.endByte-E.startByte<=ct?E.endByte=I.endByte:(E&&a.push(E),E={...I})}E&&a.push(E)}l=h}return isFinite(n)||(n=l),a.push(..._),{metadata:e,rowStart:t,rowEnd:n,columns:i,fetches:a,groups:o}}function Ye(e,{fetches:t}){let n=t.map(({startByte:i,endByte:r})=>e.slice(i,r));return{byteLength:e.byteLength,slice(i,r=e.byteLength){let f=t.findIndex(({startByte:s,endByte:o})=>s<=i&&r<=o);if(f<0)return e.slice(i,r);if(t[f].startByte!==i||t[f].endByte!==r){let s=i-t[f].startByte,o=r-t[f].startByte;return n[f]instanceof Promise?n[f].then(a=>a.slice(s,o)):n[f].slice(s,o)}else return n[f]}}}var he=new TextDecoder,Ge=new WeakMap;function ge(e,t=P){if(Array.isArray(e))return e.map(n=>ge(n,t));if(typeof e!="object")return e;if("metadata"in e){let n=at(e.metadata),i=e.typed_value&&ee(e.typed_value,n,t),r=e.value&&q(te(e.value),n,t);return i&&r?{...r,...i}:i??r}return e}function ee(e,t,n){if(e&&typeof e=="object"&&!Array.isArray(e)&&!(e instanceof Uint8Array)){if("typed_value"in e)return ee(e.typed_value,t,n);if("value"in e&&e.value instanceof Uint8Array)return q(te(e.value),t,n);let i={};for(let[r,f]of Object.entries(e))i[r]=ee(f,t,n);return i}return e instanceof Uint8Array?q(te(e),t,n):Array.isArray(e)?e.map(i=>ee(i,t,n)):e}function te(e){return{view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0}}function at(e){let t=Ge.get(e.buffer);t||(t=new Map,Ge.set(e.buffer,t));let n=`${e.byteOffset}:${e.byteLength}`,i=t.get(n);if(i)return i;let r=te(e),f=r.view.getUint8(r.offset++),s=f&15;if(s!==1)throw new Error(`parquet unsupported variant metadata version: ${s}`);let o=(f>>4&1)===1,a=(f>>6&3)+1,_=B(r,a),c=new Array(_+1);for(let h=0;h<c.length;h++)c[h]=B(r,a);let l=r.offset,d=new Array(_);for(let h=0;h<_;h++){let g=c[h],p=c[h+1],u=new Uint8Array(e.buffer,e.byteOffset+l+g,p-g);d[h]=he.decode(u)}let m={dictionary:d,sorted:o};return t.set(n,m),m}function B(e,t){let n=0;for(let i=0;i<t;i++)n|=e.view.getUint8(e.offset+i)<<i*8;return e.offset+=t,n}function q(e,t,n){let i=e.view.getUint8(e.offset++),r=i&3,f=i>>2;if(r===0)return ut(e,f,n);if(r===2)return _t(e,f,t,n);if(r===3)return dt(e,f,t,n);let s=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,f);return e.offset+=f,he.decode(s)}function ut(e,t,n){switch(t){case 0:return null;case 1:return!0;case 2:return!1;case 3:{let i=e.view.getInt8(e.offset);return e.offset+=1,i}case 4:{let i=e.view.getInt16(e.offset,!0);return e.offset+=2,i}case 5:{let i=e.view.getInt32(e.offset,!0);return e.offset+=4,i}case 6:{let i=e.view.getBigInt64(e.offset,!0);return e.offset+=8,i}case 7:{let i=e.view.getFloat64(e.offset,!0);return e.offset+=8,i}case 8:return me(e,4);case 9:return me(e,8);case 10:return me(e,16);case 11:{let i=e.view.getInt32(e.offset,!0);return e.offset+=4,n.dateFromDays(i)}case 12:case 13:{let i=e.view.getBigInt64(e.offset,!0);return e.offset+=8,n.timestampFromMicroseconds(i)}case 14:{let i=e.view.getFloat32(e.offset,!0);return e.offset+=4,i}case 15:return Ve(e);case 16:{let i=Ve(e);return he.decode(i)}case 17:{let i=e.view.getBigInt64(e.offset,!0);return e.offset+=8,i}case 18:case 19:{let i=e.view.getBigInt64(e.offset,!0);return e.offset+=8,n.timestampFromNanoseconds(i)}case 20:{let i=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,16);e.offset+=16;let r=Array.from(i,f=>f.toString(16).padStart(2,"0")).join("");return`${r.slice(0,8)}-${r.slice(8,12)}-${r.slice(12,16)}-${r.slice(16,20)}-${r.slice(20)}`}default:throw new Error(`parquet unsupported variant primitive type: ${t}`)}}function _t(e,t,n,i){let r=(t&3)+1,f=(t>>2&3)+1,o=t>>4&1?B(e,4):e.view.getUint8(e.offset++),a=new Array(o);for(let l=0;l<o;l++)a[l]=B(e,f);let _=new Array(o+1);for(let l=0;l<_.length;l++)_[l]=B(e,r);let c={};for(let l=0;l<o;l++){let d=n.dictionary[a[l]],m={view:e.view,offset:e.offset+_[l]};c[d]=q(m,n,i)}return e.offset+=_[_.length-1],c}function dt(e,t,n,i){let r=t&3,f=t>>2&1,s=r+1,o=B(e,f?4:1),a=new Array(o+1);for(let l=0;l<a.length;l++)a[l]=B(e,s);let _=e.offset,c=new Array(o);for(let l=0;l<o;l++){let d={view:e.view,offset:_+a[l]};c[l]=q(d,n,i)}return e.offset=_+a[a.length-1],c}function me(e,t){let n=e.view.getUint8(e.offset);e.offset+=1;let i;if(t===4)i=BigInt(e.view.getInt32(e.offset,!0)),e.offset+=4;else if(t===8)i=e.view.getBigInt64(e.offset,!0),e.offset+=8;else{let r=e.view.getBigUint64(e.offset,!0);i=e.view.getBigInt64(e.offset+8,!0)<<64n|r,e.offset+=16}return Number(i)*10**-n}function Ve(e){let t=e.view.getUint32(e.offset,!0);e.offset+=4;let n=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t,n}function ye(e,t,n,i,r){let f=F(r);if(!t?.length&&!n.length){if(!f||!i.length)return i;t=new Array(i.length).fill(f)}let s=t?.length||n.length,o=r.map(({element:h})=>h.repetition_type),a=0,_=[e],c=e,l=0,d=0,m=0;if(n[0])for(;l<o.length-2&&m<n[0];)l++,o[l]!=="REQUIRED"&&(c=c.at(-1),_.push(c),d++),o[l]==="REPEATED"&&m++;for(let h=0;h<s;h++){let g=t?.length?t[h]:f,p=n[h];for(;l&&(p<m||o[l]!=="REPEATED");)o[l]!=="REQUIRED"&&(_.pop(),d--),o[l]==="REPEATED"&&m--,l--;for(c=_.at(-1);(l<o.length-2||o[l+1]==="REPEATED")&&(d<g||o[l+1]==="REQUIRED");){if(l++,o[l]!=="REQUIRED"){let u=[];c.push(u),c=u,_.push(u),d++}o[l]==="REPEATED"&&m++}g===f?c.push(i[a++]):l===o.length-2?c.push(null):c.push([])}if(!e.length)for(let h=0;h<f;h++){let g=[];c.push(g),c=g}return e}function M(e,t,n,i=0){let r=t.path.join("."),f=t.element.repetition_type==="OPTIONAL",s=f?i+1:i;if(Pe(t)){let o=t.children[0],a=s;o.children.length===1&&(o=o.children[0],a++),M(e,o,n,a);let _=o.path.join("."),c=e.get(_);if(!c)throw new Error("parquet list column missing values");f&&ne(c,i),e.set(r,c),e.delete(_);return}if(Be(t)){let o=t.children[0].element.name;M(e,t.children[0].children[0],n,s+1),M(e,t.children[0].children[1],n,s+1);let a=e.get(`${r}.${o}.key`),_=e.get(`${r}.${o}.value`);if(!a)throw new Error("parquet map column missing keys");if(!_)throw new Error("parquet map column missing values");if(a.length!==_.length)throw new Error("parquet map column key/value length mismatch");let c=je(a,_,s);f&&ne(c,i),e.delete(`${r}.${o}.key`),e.delete(`${r}.${o}.value`),e.set(r,c);return}if(t.children.length){let o=t.element.repetition_type==="REQUIRED"?i:i+1,a={};for(let c of t.children){M(e,c,n,o);let l=e.get(c.path.join("."));if(!l)throw new Error("parquet struct missing child data");a[c.element.name]=l}for(let c of t.children)e.delete(c.path.join("."));let _=ze(a,o);t.element.logical_type?.type==="VARIANT"&&(_=ge(_,n)),f&&ne(_,i),e.set(r,_)}}function ne(e,t){for(let n=0;n<e.length;n++)t?ne(e[n],t-1):e[n]=e[n][0]}function je(e,t,n){let i=[];for(let r=0;r<e.length;r++)if(n)i.push(je(e[r],t[r],n-1));else if(e[r]){let f={};for(let s=0;s<e[r].length;s++){let o=t[r][s];f[e[r][s]]=o===void 0?null:o}i.push(f)}else i.push(void 0);return i}function ze(e,t){let n=Object.keys(e),i=e[n[0]]?.length,r=[];for(let f=0;f<i;f++){let s={};for(let o of n){if(e[o].length!==i)throw new Error("parquet struct parsing error");s[o]=e[o][f]}t?r.push(ze(s,t-1)):r.push(s)}return r}function $(e,t,n){let i=n instanceof Int32Array,r=L(e),f=L(e);L(e);let s=K(e),o=0;n[o++]=i?Number(s):s;let a=r/f;for(;o<t;){let _=K(e),c=new Uint8Array(f);for(let l=0;l<f;l++)c[l]=e.view.getUint8(e.offset++);for(let l=0;l<f&&o<t;l++){let d=BigInt(c[l]);if(d){let m=0n,h=a,g=(1n<<d)-1n;for(;h&&o<t;){let p=BigInt(e.view.getUint8(e.offset))>>m&g;for(m+=d;m>=8;)m-=8n,e.offset++,m&&(p|=BigInt(e.view.getUint8(e.offset))<<d-m&g);let u=_+p;s+=u,n[o++]=i?Number(s):s,h--}h&&(e.offset+=Math.ceil((h*Number(d)+Number(m))/8))}else for(let m=0;m<a&&o<t;m++)s+=_,n[o++]=i?Number(s):s}}}function we(e,t,n){let i=new Int32Array(t);$(e,t,i);for(let r=0;r<t;r++)n[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i[r]),e.offset+=i[r]}function We(e,t,n){let i=new Int32Array(t);$(e,t,i);let r=new Int32Array(t);$(e,t,r);for(let f=0;f<t;f++){let s=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r[f]);i[f]?(n[f]=new Uint8Array(i[f]+r[f]),n[f].set(n[f-1].subarray(0,i[f])),n[f].set(s,i[f])):n[f]=s,e.offset+=r[f]}}function Y(e){return 32-Math.clz32(e)}function N(e,t,n,i){i===void 0&&(i=e.view.getUint32(e.offset,!0),e.offset+=4);let r=e.offset,f=0;for(;f<n.length;){let s=L(e);if(s&1)f=mt(e,s,t,n,f);else{let o=s>>>1;pt(e,o,t,n,f),f+=o}}e.offset=r+i}function pt(e,t,n,i,r){let f=n+7>>3,s=0;for(let o=0;o<f;o++)s|=e.view.getUint8(e.offset++)<<(o<<3);for(let o=0;o<t;o++)i[r+o]=s}function mt(e,t,n,i,r){let f=t>>1<<3,s=(1<<n)-1,o=0;if(e.offset<e.view.byteLength)o=e.view.getUint8(e.offset++);else if(s)throw new Error(`parquet bitpack offset ${e.offset} out of range`);let a=8,_=0;for(;f;)_>8?(_-=8,a-=8,o>>>=8):a-_<n?(o|=e.view.getUint8(e.offset)<<a,e.offset++,a+=8):(r<i.length&&(i[r++]=o>>_&s),f--,_+=n);return r}function Ae(e,t,n,i){let r=ht(n,i),f=new Uint8Array(t*r);for(let s=0;s<r;s++)for(let o=0;o<t;o++)f[o*r+s]=e.view.getUint8(e.offset++);if(n==="FLOAT")return new Float32Array(f.buffer);if(n==="DOUBLE")return new Float64Array(f.buffer);if(n==="INT32")return new Int32Array(f.buffer);if(n==="INT64")return new BigInt64Array(f.buffer);if(n==="FIXED_LEN_BYTE_ARRAY"){let s=new Array(t);for(let o=0;o<t;o++)s[o]=f.subarray(o*r,(o+1)*r);return s}throw new Error(`parquet byte_stream_split unsupported type: ${n}`)}function ht(e,t){switch(e){case"INT32":case"FLOAT":return 4;case"INT64":case"DOUBLE":return 8;case"FIXED_LEN_BYTE_ARRAY":if(!t)throw new Error("parquet byteWidth missing type_length");return t;default:throw new Error(`parquet unsupported type: ${e}`)}}function G(e,t,n,i){if(n===0)return[];if(t==="BOOLEAN")return gt(e,n);if(t==="INT32")return yt(e,n);if(t==="INT64")return wt(e,n);if(t==="INT96")return At(e,n);if(t==="FLOAT")return Et(e,n);if(t==="DOUBLE")return It(e,n);if(t==="BYTE_ARRAY")return vt(e,n);if(t==="FIXED_LEN_BYTE_ARRAY"){if(!i)throw new Error("parquet missing fixed length");return bt(e,n,i)}else throw new Error(`parquet unhandled type: ${t}`)}function gt(e,t){let n=new Array(t);for(let i=0;i<t;i++){let r=e.offset+(i/8|0),f=i%8,s=e.view.getUint8(r);n[i]=(s&1<<f)!==0}return e.offset+=Math.ceil(t/8),n}function yt(e,t){let n=(e.view.byteOffset+e.offset)%4?new Int32Array(ie(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Int32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function wt(e,t){let n=(e.view.byteOffset+e.offset)%8?new BigInt64Array(ie(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new BigInt64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function At(e,t){let n=new Array(t);for(let i=0;i<t;i++){let r=e.view.getBigInt64(e.offset+i*12,!0),f=e.view.getInt32(e.offset+i*12+8,!0);n[i]=BigInt(f)<<64n|r}return e.offset+=t*12,n}function Et(e,t){let n=(e.view.byteOffset+e.offset)%4?new Float32Array(ie(e.view.buffer,e.view.byteOffset+e.offset,t*4)):new Float32Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*4,n}function It(e,t){let n=(e.view.byteOffset+e.offset)%8?new Float64Array(ie(e.view.buffer,e.view.byteOffset+e.offset,t*8)):new Float64Array(e.view.buffer,e.view.byteOffset+e.offset,t);return e.offset+=t*8,n}function vt(e,t){let n=new Array(t);for(let i=0;i<t;i++){let r=e.view.getUint32(e.offset,!0);e.offset+=4,n[i]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,r),e.offset+=r}return n}function bt(e,t,n){let i=new Array(t);for(let r=0;r<t;r++)i[r]=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,n),e.offset+=n;return i}function ie(e,t,n){let i=new ArrayBuffer(n);return new Uint8Array(i).set(new Uint8Array(e,t,n)),i}var Tt=[0,255,65535,16777215,4294967295];function He(e,t,n,i,r){for(let f=0;f<r;f++)n[i+f]=e[t+f]}function Ze(e,t){let n=e.byteLength,i=t.byteLength,r=0,f=0;for(;r<n;){let s=e[r];if(r++,s<128)break}if(i&&r>=n)throw new Error("invalid snappy length header");for(;r<n;){let s=e[r],o=0;if(r++,r>=n)throw new Error("missing eof marker");if(s&3){let a=0;switch(s&3){case 1:o=(s>>>2&7)+4,a=e[r]+(s>>>5<<8),r++;break;case 2:if(n<=r+1)throw new Error("snappy error end of input");o=(s>>>2)+1,a=e[r]+(e[r+1]<<8),r+=2;break;case 3:if(n<=r+3)throw new Error("snappy error end of input");o=(s>>>2)+1,a=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),r+=4;break;default:break}if(a===0||isNaN(a))throw new Error(`invalid offset ${a} pos ${r} inputLength ${n}`);if(a>f)throw new Error("cannot copy from before start of buffer");He(t,f-a,t,f,o),f+=o}else{let a=(s>>>2)+1;if(a>60){if(r+3>=n)throw new Error("snappy error literal pos + 3 >= inputLength");let _=a-60;a=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+(e[r+3]<<24),a=(a&Tt[_])+1,r+=_}if(r+a>n)throw new Error("snappy error literal exceeds input length");He(e,r,t,f,a),r+=a,f+=a}}if(f!==i)throw new Error("premature end of input")}function Ke(e,t,{type:n,element:i,schemaPath:r}){let f=new DataView(e.buffer,e.byteOffset,e.byteLength),s={view:f,offset:0},o,a=xt(s,t,r),{definitionLevels:_,numNulls:c}=Rt(s,t,r),l=t.num_values-c;if(t.encoding==="PLAIN")o=G(s,n,l,i.type_length);else if(t.encoding==="PLAIN_DICTIONARY"||t.encoding==="RLE_DICTIONARY"||t.encoding==="RLE"){let d=n==="BOOLEAN"?1:f.getUint8(s.offset++);d?(o=new Array(l),n==="BOOLEAN"?(N(s,d,o),o=o.map(m=>!!m)):N(s,d,o,f.byteLength-s.offset)):o=new Uint8Array(l)}else if(t.encoding==="BYTE_STREAM_SPLIT")o=Ae(s,l,n,i.type_length);else if(t.encoding==="DELTA_BINARY_PACKED")o=n==="INT32"?new Int32Array(l):new BigInt64Array(l),$(s,l,o);else if(t.encoding==="DELTA_LENGTH_BYTE_ARRAY")o=new Array(l),we(s,l,o);else throw new Error(`parquet unsupported encoding: ${t.encoding}`);return{definitionLevels:_,repetitionLevels:a,dataPage:o}}function xt(e,t,n){if(n.length>1){let i=_e(n);if(i){let r=new Array(t.num_values);return N(e,Y(i),r),r}}return[]}function Rt(e,t,n){let i=F(n);if(!i)return{definitionLevels:[],numNulls:0};let r=new Array(t.num_values);N(e,Y(i),r);let f=t.num_values;for(let s of r)s===i&&f--;return f===0&&(r.length=0),{definitionLevels:r,numNulls:f}}function re(e,t,n,i){let r,f=i?.[n];if(n==="UNCOMPRESSED")r=e;else if(f)r=f(e,t);else if(n==="SNAPPY")r=new Uint8Array(t),Ze(e,r);else throw new Error(`parquet unsupported compression codec: ${n}`);if(r?.length!==t)throw new Error(`parquet decompressed page length ${r?.length} does not match header ${t}`);return r}function Qe(e,t,n){let r={view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0},{type:f,element:s,schemaPath:o,codec:a,compressors:_}=n,c=t.data_page_header_v2;if(!c)throw new Error("parquet data page header v2 is undefined");let l=Lt(r,c,o);r.offset=c.repetition_levels_byte_length;let d=Nt(r,c,o),m=t.uncompressed_page_size-c.definition_levels_byte_length-c.repetition_levels_byte_length,h=e.subarray(r.offset);c.is_compressed!==!1&&(h=re(h,m,a,_));let g=new DataView(h.buffer,h.byteOffset,h.byteLength),p={view:g,offset:0},u,y=c.num_values-c.num_nulls;if(c.encoding==="PLAIN")u=G(p,f,y,s.type_length);else if(c.encoding==="RLE")u=new Array(y),N(p,1,u),u=u.map(w=>!!w);else if(c.encoding==="PLAIN_DICTIONARY"||c.encoding==="RLE_DICTIONARY"){let w=g.getUint8(p.offset++);u=new Array(y),N(p,w,u,m-1)}else if(c.encoding==="DELTA_BINARY_PACKED")u=f==="INT32"?new Int32Array(y):new BigInt64Array(y),$(p,y,u);else if(c.encoding==="DELTA_LENGTH_BYTE_ARRAY")u=new Array(y),we(p,y,u);else if(c.encoding==="DELTA_BYTE_ARRAY")u=new Array(y),We(p,y,u);else if(c.encoding==="BYTE_STREAM_SPLIT")u=Ae(p,y,f,s.type_length);else throw new Error(`parquet unsupported encoding: ${c.encoding}`);return{definitionLevels:d,repetitionLevels:l,dataPage:u}}function Lt(e,t,n){let i=_e(n);if(!i)return[];let r=new Array(t.num_values);return N(e,Y(i),r,t.repetition_levels_byte_length),r}function Nt(e,t,n){let i=F(n);if(i){let r=new Array(t.num_values);return N(e,Y(i),r,t.definition_levels_byte_length),r}}function Ee(e,{groupStart:t,selectStart:n,selectEnd:i},r,f){let{pathInSchema:s,schemaPath:o}=r,a=de(o),_=[],c,l,d=0,m=f&&(()=>{l&&f({pathInSchema:s,columnData:l,rowStart:t+d-l.length,rowEnd:t+d})});for(;(a?d<i:e.offset<e.view.byteLength-1)&&!(e.offset>=e.view.byteLength-1);){let h=Ot(e);if(h.type==="DICTIONARY_PAGE")c=Je(e,h,r,c,void 0,0),c=ce(c,r);else{let g=l?.length||0,p=Je(e,h,r,c,l,n-d);l===p?d+=p.length-g:(m?.(),_.push(p),d+=p.length,l=p)}}return m?.(),_}function Je(e,t,n,i,r,f){let{type:s,element:o,schemaPath:a,codec:_,compressors:c}=n,l=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,t.compressed_page_size);if(e.offset+=t.compressed_page_size,t.type==="DATA_PAGE"){let d=t.data_page_header;if(!d)throw new Error("parquet data page header is undefined");if(f>d.num_values&&de(a))return new Array(d.num_values);let m=re(l,Number(t.uncompressed_page_size),_,c),{definitionLevels:h,repetitionLevels:g,dataPage:p}=Ke(m,d,n),u=le(p,i,d.encoding,n),y=Array.isArray(r)?r:[];return ye(y,h,g,u,a)}else if(t.type==="DATA_PAGE_V2"){let d=t.data_page_header_v2;if(!d)throw new Error("parquet data page header v2 is undefined");if(f>d.num_rows)return new Array(d.num_values);let{definitionLevels:m,repetitionLevels:h,dataPage:g}=Qe(l,t,n),p=le(g,i,d.encoding,n),u=Array.isArray(r)?r:[];return ye(u,m,h,p,a)}else if(t.type==="DICTIONARY_PAGE"){let d=t.dictionary_page_header;if(!d)throw new Error("parquet dictionary page header is undefined");let m=re(l,Number(t.uncompressed_page_size),_,c),h={view:new DataView(m.buffer,m.byteOffset,m.byteLength),offset:0};return G(h,s,d.num_values,o.type_length)}else throw new Error(`parquet unsupported page type: ${t.type}`)}function Ot(e){let t=D(e),n=j[t.field_1],i=t.field_2,r=t.field_3,f=t.field_4,s=t.field_5&&{num_values:t.field_5.field_1,encoding:R[t.field_5.field_2],definition_level_encoding:R[t.field_5.field_3],repetition_level_encoding:R[t.field_5.field_4],statistics:t.field_5.field_5&&{max:t.field_5.field_5.field_1,min:t.field_5.field_5.field_2,null_count:t.field_5.field_5.field_3,distinct_count:t.field_5.field_5.field_4,max_value:t.field_5.field_5.field_5,min_value:t.field_5.field_5.field_6}},o=t.field_6,a=t.field_7&&{num_values:t.field_7.field_1,encoding:R[t.field_7.field_2],is_sorted:t.field_7.field_3},_=t.field_8&&{num_values:t.field_8.field_1,num_nulls:t.field_8.field_2,num_rows:t.field_8.field_3,encoding:R[t.field_8.field_4],definition_levels_byte_length:t.field_8.field_5,repetition_levels_byte_length:t.field_8.field_6,is_compressed:t.field_8.field_7===void 0?!0:t.field_8.field_7,statistics:t.field_8.field_8};return{type:n,uncompressed_page_size:i,compressed_page_size:r,crc:f,data_page_header:s,index_page_header:o,dictionary_page_header:a,data_page_header_v2:_}}function Xe(e,{metadata:t},n){let{file:i,compressors:r,utf8:f}=e,s=[],o={...P,...e.parsers};for(let a of n.chunks){let{columnMetadata:_}=a,c=H(t.schema,_.path_in_schema),l={pathInSchema:_.path_in_schema,type:_.type,element:c[c.length-1].element,schemaPath:c,codec:_.codec,parsers:o,compressors:r,utf8:f};if(!("offsetIndex"in a)){s.push({pathInSchema:_.path_in_schema,data:Promise.resolve(i.slice(a.range.startByte,a.range.endByte)).then(d=>{let m={view:new DataView(d),offset:0};return{pageSkip:0,data:Ee(m,n,l,e.onPage)}})});continue}s.push({pathInSchema:_.path_in_schema,data:Promise.resolve(i.slice(a.offsetIndex.startByte,a.offsetIndex.endByte)).then(async d=>{let m=ke({view:new DataView(d),offset:0}),{selectStart:h,selectEnd:g}=n,p=m.page_locations,u=NaN,y=NaN,w=0;for(let O=0;O<p.length;O++){let x=p[O],S=Number(x.first_row_index),V=O+1<p.length?Number(p[O+1].first_row_index):n.groupRows;S<g&&V>h&&(Number.isNaN(u)&&(u=Number(x.offset),w=S),y=Number(x.offset)+x.compressed_page_size)}let E=await i.slice(u,y),A={view:new DataView(E),offset:0},I=w?{...n,groupStart:n.groupStart+w,selectStart:n.selectStart-w,selectEnd:n.selectEnd-w}:n;return{data:Ee(A,I,l,e.onPage),pageSkip:w}})})}return{groupStart:n.groupStart,groupRows:n.groupRows,asyncColumns:s}}async function Ie({asyncColumns:e},t,n,i,r){let f=await Promise.all(e.map(async({data:l})=>{let d=await l;return{...d,data:J(d.data)}})),s=e.map(l=>l.pathInSchema[0]).filter(l=>!i||i.includes(l)),o=i??s,a=o.map(l=>e.findIndex(d=>d.pathInSchema[0]===l)),_=n-t;if(r==="object"){let l=Array(_);for(let d=0;d<_;d++){let m=t+d,h={};for(let g=0;g<e.length;g++){let{data:p,pageSkip:u}=f[g];h[e[g].pathInSchema[0]]=p[m-u]}l[d]=h}return l}let c=Array(_);for(let l=0;l<_;l++){let d=t+l,m=Array(e.length);for(let h=0;h<o.length;h++){let g=a[h];if(g>=0){let{data:p,pageSkip:u}=f[g];m[h]=p[d-u]}}c[l]=m}return c}function et(e,t,n){let{asyncColumns:i}=e;n={...P,...n};let r=[];for(let f of t.children)if(f.children.length){let s=i.filter(_=>_.pathInSchema[0]===f.element.name);if(!s.length)continue;let o=new Map,a=Promise.all(s.map(_=>_.data.then(({data:c})=>{o.set(_.pathInSchema.join("."),J(c))}))).then(()=>{M(o,f,n);let _=o.get(f.path.join("."));if(!_)throw new Error("parquet column data not assembled");return{data:[_],pageSkip:0}});r.push({pathInSchema:f.path,data:a})}else{let s=i.find(o=>o.pathInSchema[0]===f.element.name);s&&r.push(s)}return{...e,asyncColumns:r}}async function ve(e){e.metadata??=await Ce(e.file,e);let{rowStart:t=0,rowEnd:n,columns:i,onChunk:r,onComplete:f,rowFormat:s,filter:o,filterStrict:a=!0}=e;if(o&&s!=="object")throw new Error('parquet filter requires rowFormat: "object"');let _=k(o);if(_.length){let p=C(e.metadata).children.map(y=>y.element.name),u=_.filter(y=>!p.includes(y));if(u.length)throw new Error(`parquet filter columns not found: ${u.join(", ")}`)}let c=i,l=!1;if(i&&o){let p=_.filter(u=>!i.includes(u));p.length&&(c=[...i,...p],l=!0)}let d=c!==i?{...e,columns:c}:e,m=St(d);if(!f&&!r){for(let{asyncColumns:p}of m)for(let{data:u}of p)await u;return}let h=C(e.metadata),g=m.map(p=>et(p,h,e.parsers));if(r)for(let p of g)for(let u of p.asyncColumns)u.data.then(({data:y,pageSkip:w})=>{let E=p.groupStart+w;for(let A of y)r({columnName:u.pathInSchema[0],columnData:A,rowStart:E,rowEnd:E+A.length}),E+=A.length});if(f){let p=[];for(let u of g){let y=Math.max(t-u.groupStart,0),w=Math.min((n??1/0)-u.groupStart,u.groupRows),E=s==="object"?await Ie(u,y,w,c,"object"):await Ie(u,y,w,i,"array");if(o){for(let A of E)if(U(A,o,a)){if(l&&i)for(let I of _)i.includes(I)||delete A[I];p.push(A)}}else pe(p,E)}f(p)}else for(let{asyncColumns:p}of g)for(let{data:u}of p)await u}function St(e){if(!e.metadata)throw new Error("parquet requires metadata");let t=qe(e);return e.file=Ye(e.file,t),t.groups.map(n=>Xe(e,t,n))}function tt(e){return new Promise((t,n)=>{ve({...e,rowFormat:"object",onComplete:t}).catch(n)})}export{ve as parquetRead,tt as parquetReadObjects};
