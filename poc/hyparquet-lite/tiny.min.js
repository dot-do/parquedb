var T=["BOOLEAN","INT32","INT64","INT96","FLOAT","DOUBLE","BYTE_ARRAY","FIXED_LEN_BYTE_ARRAY"],L=["PLAIN","GROUP_VAR_INT","PLAIN_DICTIONARY","RLE","BIT_PACKED","DELTA_BINARY_PACKED","DELTA_LENGTH_BYTE_ARRAY","DELTA_BYTE_ARRAY","RLE_DICTIONARY","BYTE_STREAM_SPLIT"],M=["REQUIRED","OPTIONAL","REPEATED"],S=["UTF8","MAP","MAP_KEY_VALUE","LIST","ENUM","DECIMAL","DATE","TIME_MILLIS","TIME_MICROS","TIMESTAMP_MILLIS","TIMESTAMP_MICROS","UINT_8","UINT_16","UINT_32","UINT_64","INT_8","INT_16","INT_32","INT_64","JSON","BSON","INTERVAL"],O=["UNCOMPRESSED","SNAPPY","GZIP","LZO","BROTLI","LZ4","ZSTD","LZ4_RAW"],D=["DATA_PAGE","INDEX_PAGE","DICTIONARY_PAGE","DATA_PAGE_V2"];var P=["SPHERICAL","VINCENTY","THOMAS","ANDOYER","KARNEY"];function A(e){let n=E(e);if(n.type===1)return{type:"Point",coordinates:N(e,n)};if(n.type===2)return{type:"LineString",coordinates:R(e,n)};if(n.type===3)return{type:"Polygon",coordinates:U(e,n)};if(n.type===4){let i=[];for(let t=0;t<n.count;t++)i.push(N(e,E(e)));return{type:"MultiPoint",coordinates:i}}else if(n.type===5){let i=[];for(let t=0;t<n.count;t++)i.push(R(e,E(e)));return{type:"MultiLineString",coordinates:i}}else if(n.type===6){let i=[];for(let t=0;t<n.count;t++)i.push(U(e,E(e)));return{type:"MultiPolygon",coordinates:i}}else if(n.type===7){let i=[];for(let t=0;t<n.count;t++)i.push(A(e));return{type:"GeometryCollection",geometries:i}}else throw new Error(`Unsupported geometry type: ${n.type}`)}function E(e){let{view:n}=e,i=n.getUint8(e.offset++)===1,t=n.getUint32(e.offset,i);e.offset+=4;let f=t%1e3,r=Math.floor(t/1e3),s=0;f>1&&f<=7&&(s=n.getUint32(e.offset,i),e.offset+=4);let _=2;return r&&_++,r===3&&_++,{littleEndian:i,type:f,dim:_,count:s}}function N(e,n){let i=[];for(let t=0;t<n.dim;t++){let f=e.view.getFloat64(e.offset,n.littleEndian);e.offset+=8,i.push(f)}return i}function R(e,n){let i=[];for(let t=0;t<n.count;t++)i.push(N(e,n));return i}function U(e,n){let{view:i}=e,t=[];for(let f=0;f<n.count;f++){let r=i.getUint32(e.offset,n.littleEndian);e.offset+=4,t.push(R(e,{...n,count:r}))}return t}var J=new TextDecoder,b={timestampFromMilliseconds(e){return new Date(Number(e))},timestampFromMicroseconds(e){return new Date(Number(e/1000n))},timestampFromNanoseconds(e){return new Date(Number(e/1000000n))},dateFromDays(e){return new Date(e*864e5)},stringFromBytes(e){return e&&J.decode(e)},geometryFromBytes(e){return e&&A({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})},geographyFromBytes(e){return e&&A({view:new DataView(e.buffer,e.byteOffset,e.byteLength),offset:0})}};function F(e){if(!e.length)return 0;let n=0n;for(let t of e)n=n*256n+BigInt(t);let i=e.length*8;return n>=2n**BigInt(i-1)&&(n-=2n**BigInt(i)),Number(n)}function B(e){if(!e)return;let n=e[1]<<8|e[0],i=n>>15?-1:1,t=n>>10&31,f=n&1023;return t===0?i*2**-14*(f/1024):t===31?f?NaN:i*(1/0):i*2**(t-15)*(1+f/1024)}function C(e,n,i){let t=e[n],f=[],r=1;if(t.num_children)for(;f.length<t.num_children;){let s=e[n+r],_=C(e,n+r,[...i,s.name]);r+=_.count,f.push(_)}return{count:r,element:t,children:f,path:i}}function v(e,n){let i=C(e,0,[]),t=[i];for(let f of n){let r=i.children.find(s=>s.element.name===f);if(!r)throw new Error(`parquet schema element not found: ${n}`);t.push(r),i=r}return t}var d={STOP:0,TRUE:1,FALSE:2,BYTE:3,I16:4,I32:5,I64:6,DOUBLE:7,BINARY:8,LIST:9,SET:10,MAP:11,STRUCT:12,UUID:13};function Y(e){let n=0,i={};for(;e.offset<e.view.byteLength;){let[t,f,r]=G(e,n);if(n=r,t===d.STOP)break;i[`field_${f}`]=h(e,t)}return i}function h(e,n){switch(n){case d.TRUE:return!0;case d.FALSE:return!1;case d.BYTE:return e.view.getInt8(e.offset++);case d.I16:case d.I32:return q(e);case d.I64:return Q(e);case d.DOUBLE:{let i=e.view.getFloat64(e.offset,!0);return e.offset+=8,i}case d.BINARY:{let i=w(e),t=new Uint8Array(e.view.buffer,e.view.byteOffset+e.offset,i);return e.offset+=i,t}case d.LIST:{let i=e.view.getUint8(e.offset++),t=i&15,f=i>>4;f===15&&(f=w(e));let r=t===d.TRUE||t===d.FALSE,s=new Array(f);for(let _=0;_<f;_++)s[_]=r?h(e,d.BYTE)===1:h(e,t);return s}case d.STRUCT:{let i={},t=0;for(;;){let[f,r,s]=G(e,t);if(t=s,f===d.STOP)break;i[`field_${r}`]=h(e,f)}return i}default:throw new Error(`thrift unhandled type: ${n}`)}}function w(e){let n=0,i=0;for(;;){let t=e.view.getUint8(e.offset++);if(n|=(t&127)<<i,!(t&128))return n;i+=7}}function K(e){let n=0n,i=0n;for(;;){let t=e.view.getUint8(e.offset++);if(n|=BigInt(t&127)<<i,!(t&128))return n;i+=7n}}function q(e){let n=w(e);return n>>>1^-(n&1)}function Q(e){let n=K(e);return n>>1n^-(n&1n)}function G(e,n){let i=e.view.getUint8(e.offset++),t=i&15;if(t===d.STOP)return[0,0,n];let f=i>>4,r=f?n+f:q(e);return[t,r,r]}function V(e,n){let i=new Map,t=n?.find(({key:r})=>r==="geo")?.value,f=(t&&JSON.parse(t)?.columns)??{};for(let[r,s]of Object.entries(f)){if(s.encoding!=="WKB")continue;let _=s.edges==="spherical"?"GEOGRAPHY":"GEOMETRY",u=s.crs?.id??s.crs?.ids?.[0],p=u?`${u.authority}:${u.code.toString()}`:void 0;i.set(r,{type:_,crs:p})}for(let r=1;r<e.length;r++){let s=e[r],{logical_type:_,name:u,num_children:p,repetition_type:a,type:y}=s;if(p){r+=p;continue}y==="BYTE_ARRAY"&&_===void 0&&a!=="REPEATED"&&(s.logical_type=i.get(u))}}var X=1<<19,ee=new TextDecoder;function c(e){return e&&ee.decode(e)}async function k(e,{parsers:n,initialFetchSize:i=X,geoparquet:t=!0}={}){if(!e||!(e.byteLength>=0))throw new Error("parquet expected AsyncBuffer");let f=Math.max(0,e.byteLength-i),r=await e.slice(f,e.byteLength),s=new DataView(r);if(s.getUint32(r.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let _=s.getUint32(r.byteLength-8,!0);if(_>e.byteLength-8)throw new Error(`parquet metadata length ${_} exceeds available buffer ${e.byteLength-8}`);if(_+8>i){let u=e.byteLength-_-8,p=await e.slice(u,f),a=new ArrayBuffer(_+8),y=new Uint8Array(a);return y.set(new Uint8Array(p)),y.set(new Uint8Array(r),f-u),I(a,{parsers:n,geoparquet:t})}else return I(r,{parsers:n,geoparquet:t})}function I(e,{parsers:n,geoparquet:i=!0}={}){if(!(e instanceof ArrayBuffer))throw new Error("parquet expected ArrayBuffer");let t=new DataView(e);if(n={...b,...n},t.byteLength<8)throw new Error("parquet file is too short");if(t.getUint32(t.byteLength-4,!0)!==827474256)throw new Error("parquet file invalid (footer != PAR1)");let f=t.byteLength-8,r=t.getUint32(f,!0);if(r>t.byteLength-8)throw new Error(`parquet metadata length ${r} exceeds available buffer ${t.byteLength-8}`);let s=f-r,u=Y({view:t,offset:s}),p=u.field_1,a=u.field_2.map(l=>({type:T[l.field_1],type_length:l.field_2,repetition_type:M[l.field_3],name:c(l.field_4),num_children:l.field_5,converted_type:S[l.field_6],scale:l.field_7,precision:l.field_8,field_id:l.field_9,logical_type:te(l.field_10)})),y=a.filter(l=>l.type),Z=u.field_3,j=u.field_4.map(l=>({columns:l.field_1.map((o,H)=>({file_path:c(o.field_1),file_offset:o.field_2,meta_data:o.field_3&&{type:T[o.field_3.field_1],encodings:o.field_3.field_2?.map(m=>L[m]),path_in_schema:o.field_3.field_3.map(c),codec:O[o.field_3.field_4],num_values:o.field_3.field_5,total_uncompressed_size:o.field_3.field_6,total_compressed_size:o.field_3.field_7,key_value_metadata:o.field_3.field_8?.map(m=>({key:c(m.field_1),value:c(m.field_2)})),data_page_offset:o.field_3.field_9,index_page_offset:o.field_3.field_10,dictionary_page_offset:o.field_3.field_11,statistics:ne(o.field_3.field_12,y[H],n),encoding_stats:o.field_3.field_13?.map(m=>({page_type:D[m.field_1],encoding:L[m.field_2],count:m.field_3})),bloom_filter_offset:o.field_3.field_14,bloom_filter_length:o.field_3.field_15,size_statistics:o.field_3.field_16&&{unencoded_byte_array_data_bytes:o.field_3.field_16.field_1,repetition_level_histogram:o.field_3.field_16.field_2,definition_level_histogram:o.field_3.field_16.field_3},geospatial_statistics:o.field_3.field_17&&{bbox:o.field_3.field_17.field_1&&{xmin:o.field_3.field_17.field_1.field_1,xmax:o.field_3.field_17.field_1.field_2,ymin:o.field_3.field_17.field_1.field_3,ymax:o.field_3.field_17.field_1.field_4,zmin:o.field_3.field_17.field_1.field_5,zmax:o.field_3.field_17.field_1.field_6,mmin:o.field_3.field_17.field_1.field_7,mmax:o.field_3.field_17.field_1.field_8},geospatial_types:o.field_3.field_17.field_2}},offset_index_offset:o.field_4,offset_index_length:o.field_5,column_index_offset:o.field_6,column_index_length:o.field_7,crypto_metadata:o.field_8,encrypted_column_metadata:o.field_9})),total_byte_size:l.field_2,num_rows:l.field_3,sorting_columns:l.field_4?.map(o=>({column_idx:o.field_1,descending:o.field_2,nulls_first:o.field_3})),file_offset:l.field_5,total_compressed_size:l.field_6,ordinal:l.field_7})),x=u.field_5?.map(l=>({key:c(l.field_1),value:c(l.field_2)})),W=c(u.field_6);return i&&V(a,x),{version:p,schema:a,num_rows:Z,row_groups:j,key_value_metadata:x,created_by:W,metadata_length:r}}function $({schema:e}){return v(e,[])[0]}function te(e){return e?.field_1?{type:"STRING"}:e?.field_2?{type:"MAP"}:e?.field_3?{type:"LIST"}:e?.field_4?{type:"ENUM"}:e?.field_5?{type:"DECIMAL",scale:e.field_5.field_1,precision:e.field_5.field_2}:e?.field_6?{type:"DATE"}:e?.field_7?{type:"TIME",isAdjustedToUTC:e.field_7.field_1,unit:z(e.field_7.field_2)}:e?.field_8?{type:"TIMESTAMP",isAdjustedToUTC:e.field_8.field_1,unit:z(e.field_8.field_2)}:e?.field_10?{type:"INTEGER",bitWidth:e.field_10.field_1,isSigned:e.field_10.field_2}:e?.field_11?{type:"NULL"}:e?.field_12?{type:"JSON"}:e?.field_13?{type:"BSON"}:e?.field_14?{type:"UUID"}:e?.field_15?{type:"FLOAT16"}:e?.field_16?{type:"VARIANT",specification_version:e.field_16.field_1}:e?.field_17?{type:"GEOMETRY",crs:c(e.field_17.field_1)}:e?.field_18?{type:"GEOGRAPHY",crs:c(e.field_18.field_1),algorithm:P[e.field_18.field_2]}:e}function z(e){if(e.field_1)return"MILLIS";if(e.field_2)return"MICROS";if(e.field_3)return"NANOS";throw new Error("parquet time unit required")}function ne(e,n,i){return e&&{max:g(e.field_1,n,i),min:g(e.field_2,n,i),null_count:e.field_3,distinct_count:e.field_4,max_value:g(e.field_5,n,i),min_value:g(e.field_6,n,i),is_max_value_exact:e.field_7,is_min_value_exact:e.field_8}}function g(e,n,i){let{type:t,converted_type:f,logical_type:r}=n;if(e===void 0)return e;if(t==="BOOLEAN")return e[0]===1;if(t==="BYTE_ARRAY")return i.stringFromBytes(e);let s=new DataView(e.buffer,e.byteOffset,e.byteLength);return t==="FLOAT"&&s.byteLength===4?s.getFloat32(0,!0):t==="DOUBLE"&&s.byteLength===8?s.getFloat64(0,!0):t==="INT32"&&f==="DATE"?i.dateFromDays(s.getInt32(0,!0)):t==="INT64"&&f==="TIMESTAMP_MILLIS"?i.timestampFromMilliseconds(s.getBigInt64(0,!0)):t==="INT64"&&f==="TIMESTAMP_MICROS"?i.timestampFromMicroseconds(s.getBigInt64(0,!0)):t==="INT64"&&r?.type==="TIMESTAMP"&&r?.unit==="NANOS"?i.timestampFromNanoseconds(s.getBigInt64(0,!0)):t==="INT64"&&r?.type==="TIMESTAMP"&&r?.unit==="MICROS"?i.timestampFromMicroseconds(s.getBigInt64(0,!0)):t==="INT64"&&r?.type==="TIMESTAMP"?i.timestampFromMilliseconds(s.getBigInt64(0,!0)):t==="INT32"&&s.byteLength===4?s.getInt32(0,!0):t==="INT64"&&s.byteLength===8?s.getBigInt64(0,!0):f==="DECIMAL"?F(e)*10**-(n.scale||0):r?.type==="FLOAT16"?B(e):e}export{I as parquetMetadata,k as parquetMetadataAsync,$ as parquetSchema};
